;; gorilla-repl.fileformat = 1

;; **
;;; # CIM Portfolio
;; **

;; **
;;; ### Required packages
;; **

;; @@
(ns cim_portfolio.portfolio
  (:require [cim_portfolio.util :as util]
            [cim_portfolio.yfinanceclient :as client]
            [gorilla-plot.core :as plot]
            ))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; ### Portfolio Analysis Helper Functions
;; **

;; @@
;; Computes arithmetic, log, and cumulative return for a given list of prices
(defn calculate-returns [prices]
  (let [price-changes (map #(double (/ (second %) (first %))) (partition 2 1 prices))
        arithmetic-returns (mapv #(- % 1.0) price-changes)
        log-returns (mapv #(Math/log %) price-changes)
        cumulative-log-return (reduce + log-returns)]
    {
     :cumulative-return cumulative-log-return
     :arithmetic-returns arithmetic-returns
     :log-returns log-returns
     }))

;; Variation of the above function - additionally associates the returns with their corresponding date
(defn calculate-returns-with-corresponding-date [prices dates]
  (let [price-changes (map #(double (/ (second %) (first %))) (partition 2 1 prices))
        arithmetic-returns (mapv #(- % 1.0) price-changes)
        log-returns (mapv #(Math/log %) price-changes)
        cumulative-log-return (reduce + log-returns)]
    {
     :cumulative-return cumulative-log-return
     :arithmetic-returns (util/sort-map-by-date (zipmap (rest dates) arithmetic-returns))
     :log-returns (util/sort-map-by-date (zipmap (rest dates) log-returns))
     }))

;; Calculates portfolio return - accepts map {:stock cash-invested} and stock-performance generated by calculate-returns
(defn calculate-portfolio-return [cash-invested returns]
  (let [total-investment (apply + (vals cash-invested))]
    (->> cash-invested
         (map (fn [[security invested]]
                (let [weight (/ invested total-investment)
                      return (:cumulative-return (get returns security))]
                  (* weight return))))
         (apply +))))

;; Calculates cumulative return UP TILL a given date
(defn get-cumulative-return-till-given-date [cumulative-returns date]
  (util/sum-up-to-key date cumulative-returns)
)

;; Only calculates portfolio return up till a given date
(defn calculate-portfolio-return-for-given-date [cash-invested returns date]
  (let [total-investment (apply + (vals cash-invested))]
    (->> cash-invested
         (map (fn [[security invested]]
                (let [weight (/ invested total-investment)
                      return (get-cumulative-return-till-given-date (:log-returns (get returns security)) date)
                     ]
                  (* weight return))))
         (apply +))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;cim_portfolio.portfolio/calculate-portfolio-return-for-given-date</span>","value":"#'cim_portfolio.portfolio/calculate-portfolio-return-for-given-date"}
;; <=

;; @@
(calculate-returns [100 110 120 130])
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:cumulative-return</span>","value":":cumulative-return"},{"type":"html","content":"<span class='clj-double'>0.262364264467491</span>","value":"0.262364264467491"}],"value":"[:cumulative-return 0.262364264467491]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:arithmetic-returns</span>","value":":arithmetic-returns"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-double'>0.10000000000000009</span>","value":"0.10000000000000009"},{"type":"html","content":"<span class='clj-double'>0.09090909090909105</span>","value":"0.09090909090909105"},{"type":"html","content":"<span class='clj-double'>0.08333333333333304</span>","value":"0.08333333333333304"}],"value":"[0.10000000000000009 0.09090909090909105 0.08333333333333304]"}],"value":"[:arithmetic-returns [0.10000000000000009 0.09090909090909105 0.08333333333333304]]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:log-returns</span>","value":":log-returns"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-double'>0.09531017980432493</span>","value":"0.09531017980432493"},{"type":"html","content":"<span class='clj-double'>0.0870113769896299</span>","value":"0.0870113769896299"},{"type":"html","content":"<span class='clj-double'>0.08004270767353615</span>","value":"0.08004270767353615"}],"value":"[0.09531017980432493 0.0870113769896299 0.08004270767353615]"}],"value":"[:log-returns [0.09531017980432493 0.0870113769896299 0.08004270767353615]]"}],"value":"{:cumulative-return 0.262364264467491, :arithmetic-returns [0.10000000000000009 0.09090909090909105 0.08333333333333304], :log-returns [0.09531017980432493 0.0870113769896299 0.08004270767353615]}"}
;; <=

;; **
;;; ### YFinance API
;; **

;; @@
(client/get-ticker-price-all "NVDA" "2024-02-15")
;; @@
;; ->
;;; [*********************100%%**********************]  1 of 1 completed
;;; 
;; <-
;; =>
;;; {"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-16&quot;</span>","value":"\"2024-02-16\""},{"type":"html","content":"<span class='clj-double'>741.0</span>","value":"741.0"},{"type":"html","content":"<span class='clj-double'>726.0959472656</span>","value":"726.0959472656"}],"value":"[\"2024-02-16\" 741.0 726.0959472656]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-20&quot;</span>","value":"\"2024-02-20\""},{"type":"html","content":"<span class='clj-double'>719.4699707031</span>","value":"719.4699707031"},{"type":"html","content":"<span class='clj-double'>694.4874267578</span>","value":"694.4874267578"}],"value":"[\"2024-02-20\" 719.4699707031 694.4874267578]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-21&quot;</span>","value":"\"2024-02-21\""},{"type":"html","content":"<span class='clj-double'>680.0599975586</span>","value":"680.0599975586"},{"type":"html","content":"<span class='clj-double'>674.688293457</span>","value":"674.688293457"}],"value":"[\"2024-02-21\" 680.0599975586 674.688293457]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-22&quot;</span>","value":"\"2024-02-22\""},{"type":"html","content":"<span class='clj-double'>750.25</span>","value":"750.25"},{"type":"html","content":"<span class='clj-double'>785.3431396484</span>","value":"785.3431396484"}],"value":"[\"2024-02-22\" 750.25 785.3431396484]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-23&quot;</span>","value":"\"2024-02-23\""},{"type":"html","content":"<span class='clj-double'>807.9000244141</span>","value":"807.9000244141"},{"type":"html","content":"<span class='clj-double'>788.1329956055</span>","value":"788.1329956055"}],"value":"[\"2024-02-23\" 807.9000244141 788.1329956055]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-26&quot;</span>","value":"\"2024-02-26\""},{"type":"html","content":"<span class='clj-double'>797.0</span>","value":"797.0"},{"type":"html","content":"<span class='clj-double'>790.8828735352</span>","value":"790.8828735352"}],"value":"[\"2024-02-26\" 797.0 790.8828735352]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-27&quot;</span>","value":"\"2024-02-27\""},{"type":"html","content":"<span class='clj-double'>793.8099975586</span>","value":"793.8099975586"},{"type":"html","content":"<span class='clj-double'>786.9730834961</span>","value":"786.9730834961"}],"value":"[\"2024-02-27\" 793.8099975586 786.9730834961]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-28&quot;</span>","value":"\"2024-02-28\""},{"type":"html","content":"<span class='clj-double'>776.200012207</span>","value":"776.200012207"},{"type":"html","content":"<span class='clj-double'>776.5935668945</span>","value":"776.5935668945"}],"value":"[\"2024-02-28\" 776.200012207 776.5935668945]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-02-29&quot;</span>","value":"\"2024-02-29\""},{"type":"html","content":"<span class='clj-double'>790.9400024414</span>","value":"790.9400024414"},{"type":"html","content":"<span class='clj-double'>791.0828857422</span>","value":"791.0828857422"}],"value":"[\"2024-02-29\" 790.9400024414 791.0828857422]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-01&quot;</span>","value":"\"2024-03-01\""},{"type":"html","content":"<span class='clj-double'>800.0</span>","value":"800.0"},{"type":"html","content":"<span class='clj-double'>822.7514038086</span>","value":"822.7514038086"}],"value":"[\"2024-03-01\" 800.0 822.7514038086]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-04&quot;</span>","value":"\"2024-03-04\""},{"type":"html","content":"<span class='clj-double'>841.299987793</span>","value":"841.299987793"},{"type":"html","content":"<span class='clj-double'>852.3300170898</span>","value":"852.3300170898"}],"value":"[\"2024-03-04\" 841.299987793 852.3300170898]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-05&quot;</span>","value":"\"2024-03-05\""},{"type":"html","content":"<span class='clj-double'>852.700012207</span>","value":"852.700012207"},{"type":"html","content":"<span class='clj-double'>859.6400146484</span>","value":"859.6400146484"}],"value":"[\"2024-03-05\" 852.700012207 859.6400146484]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-06&quot;</span>","value":"\"2024-03-06\""},{"type":"html","content":"<span class='clj-double'>880.2199707031</span>","value":"880.2199707031"},{"type":"html","content":"<span class='clj-double'>887.0</span>","value":"887.0"}],"value":"[\"2024-03-06\" 880.2199707031 887.0]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-07&quot;</span>","value":"\"2024-03-07\""},{"type":"html","content":"<span class='clj-double'>901.5800170898</span>","value":"901.5800170898"},{"type":"html","content":"<span class='clj-double'>926.6900024414</span>","value":"926.6900024414"}],"value":"[\"2024-03-07\" 901.5800170898 926.6900024414]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-08&quot;</span>","value":"\"2024-03-08\""},{"type":"html","content":"<span class='clj-double'>951.3800048828</span>","value":"951.3800048828"},{"type":"html","content":"<span class='clj-double'>875.2800292969</span>","value":"875.2800292969"}],"value":"[\"2024-03-08\" 951.3800048828 875.2800292969]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-11&quot;</span>","value":"\"2024-03-11\""},{"type":"html","content":"<span class='clj-double'>864.2899780273</span>","value":"864.2899780273"},{"type":"html","content":"<span class='clj-double'>857.7399902344</span>","value":"857.7399902344"}],"value":"[\"2024-03-11\" 864.2899780273 857.7399902344]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-12&quot;</span>","value":"\"2024-03-12\""},{"type":"html","content":"<span class='clj-double'>880.4899902344</span>","value":"880.4899902344"},{"type":"html","content":"<span class='clj-double'>919.1300048828</span>","value":"919.1300048828"}],"value":"[\"2024-03-12\" 880.4899902344 919.1300048828]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-13&quot;</span>","value":"\"2024-03-13\""},{"type":"html","content":"<span class='clj-double'>910.549987793</span>","value":"910.549987793"},{"type":"html","content":"<span class='clj-double'>908.8800048828</span>","value":"908.8800048828"}],"value":"[\"2024-03-13\" 910.549987793 908.8800048828]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-14&quot;</span>","value":"\"2024-03-14\""},{"type":"html","content":"<span class='clj-double'>895.7700195312</span>","value":"895.7700195312"},{"type":"html","content":"<span class='clj-double'>879.4400024414</span>","value":"879.4400024414"}],"value":"[\"2024-03-14\" 895.7700195312 879.4400024414]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-15&quot;</span>","value":"\"2024-03-15\""},{"type":"html","content":"<span class='clj-double'>869.299987793</span>","value":"869.299987793"},{"type":"html","content":"<span class='clj-double'>878.3699951172</span>","value":"878.3699951172"}],"value":"[\"2024-03-15\" 869.299987793 878.3699951172]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-18&quot;</span>","value":"\"2024-03-18\""},{"type":"html","content":"<span class='clj-double'>903.8800048828</span>","value":"903.8800048828"},{"type":"html","content":"<span class='clj-double'>884.549987793</span>","value":"884.549987793"}],"value":"[\"2024-03-18\" 903.8800048828 884.549987793]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-19&quot;</span>","value":"\"2024-03-19\""},{"type":"html","content":"<span class='clj-double'>867.0</span>","value":"867.0"},{"type":"html","content":"<span class='clj-double'>893.9799804688</span>","value":"893.9799804688"}],"value":"[\"2024-03-19\" 867.0 893.9799804688]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-20&quot;</span>","value":"\"2024-03-20\""},{"type":"html","content":"<span class='clj-double'>897.9699707031</span>","value":"897.9699707031"},{"type":"html","content":"<span class='clj-double'>903.7199707031</span>","value":"903.7199707031"}],"value":"[\"2024-03-20\" 897.9699707031 903.7199707031]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-21&quot;</span>","value":"\"2024-03-21\""},{"type":"html","content":"<span class='clj-double'>923.0</span>","value":"923.0"},{"type":"html","content":"<span class='clj-double'>914.3499755859</span>","value":"914.3499755859"}],"value":"[\"2024-03-21\" 923.0 914.3499755859]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-22&quot;</span>","value":"\"2024-03-22\""},{"type":"html","content":"<span class='clj-double'>911.4099731445</span>","value":"911.4099731445"},{"type":"html","content":"<span class='clj-double'>942.8900146484</span>","value":"942.8900146484"}],"value":"[\"2024-03-22\" 911.4099731445 942.8900146484]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-25&quot;</span>","value":"\"2024-03-25\""},{"type":"html","content":"<span class='clj-double'>939.4099731445</span>","value":"939.4099731445"},{"type":"html","content":"<span class='clj-double'>950.0200195312</span>","value":"950.0200195312"}],"value":"[\"2024-03-25\" 939.4099731445 950.0200195312]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-26&quot;</span>","value":"\"2024-03-26\""},{"type":"html","content":"<span class='clj-double'>958.5100097656</span>","value":"958.5100097656"},{"type":"html","content":"<span class='clj-double'>925.6099853516</span>","value":"925.6099853516"}],"value":"[\"2024-03-26\" 958.5100097656 925.6099853516]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-27&quot;</span>","value":"\"2024-03-27\""},{"type":"html","content":"<span class='clj-double'>931.1199951172</span>","value":"931.1199951172"},{"type":"html","content":"<span class='clj-double'>902.5</span>","value":"902.5"}],"value":"[\"2024-03-27\" 931.1199951172 902.5]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-03-28&quot;</span>","value":"\"2024-03-28\""},{"type":"html","content":"<span class='clj-double'>900.0</span>","value":"900.0"},{"type":"html","content":"<span class='clj-double'>903.5599975586</span>","value":"903.5599975586"}],"value":"[\"2024-03-28\" 900.0 903.5599975586]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-01&quot;</span>","value":"\"2024-04-01\""},{"type":"html","content":"<span class='clj-double'>902.9899902344</span>","value":"902.9899902344"},{"type":"html","content":"<span class='clj-double'>903.6300048828</span>","value":"903.6300048828"}],"value":"[\"2024-04-01\" 902.9899902344 903.6300048828]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-02&quot;</span>","value":"\"2024-04-02\""},{"type":"html","content":"<span class='clj-double'>884.4799804688</span>","value":"884.4799804688"},{"type":"html","content":"<span class='clj-double'>894.5200195312</span>","value":"894.5200195312"}],"value":"[\"2024-04-02\" 884.4799804688 894.5200195312]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-03&quot;</span>","value":"\"2024-04-03\""},{"type":"html","content":"<span class='clj-double'>884.8400268555</span>","value":"884.8400268555"},{"type":"html","content":"<span class='clj-double'>889.6400146484</span>","value":"889.6400146484"}],"value":"[\"2024-04-03\" 884.8400268555 889.6400146484]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-04&quot;</span>","value":"\"2024-04-04\""},{"type":"html","content":"<span class='clj-double'>904.0599975586</span>","value":"904.0599975586"},{"type":"html","content":"<span class='clj-double'>859.049987793</span>","value":"859.049987793"}],"value":"[\"2024-04-04\" 904.0599975586 859.049987793]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-05&quot;</span>","value":"\"2024-04-05\""},{"type":"html","content":"<span class='clj-double'>868.6599731445</span>","value":"868.6599731445"},{"type":"html","content":"<span class='clj-double'>880.0800170898</span>","value":"880.0800170898"}],"value":"[\"2024-04-05\" 868.6599731445 880.0800170898]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-08&quot;</span>","value":"\"2024-04-08\""},{"type":"html","content":"<span class='clj-double'>887.0</span>","value":"887.0"},{"type":"html","content":"<span class='clj-double'>871.3300170898</span>","value":"871.3300170898"}],"value":"[\"2024-04-08\" 887.0 871.3300170898]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-09&quot;</span>","value":"\"2024-04-09\""},{"type":"html","content":"<span class='clj-double'>874.4199829102</span>","value":"874.4199829102"},{"type":"html","content":"<span class='clj-double'>853.5399780273</span>","value":"853.5399780273"}],"value":"[\"2024-04-09\" 874.4199829102 853.5399780273]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-10&quot;</span>","value":"\"2024-04-10\""},{"type":"html","content":"<span class='clj-double'>839.2600097656</span>","value":"839.2600097656"},{"type":"html","content":"<span class='clj-double'>870.3900146484</span>","value":"870.3900146484"}],"value":"[\"2024-04-10\" 839.2600097656 870.3900146484]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-11&quot;</span>","value":"\"2024-04-11\""},{"type":"html","content":"<span class='clj-double'>874.200012207</span>","value":"874.200012207"},{"type":"html","content":"<span class='clj-double'>906.1599731445</span>","value":"906.1599731445"}],"value":"[\"2024-04-11\" 874.200012207 906.1599731445]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-12&quot;</span>","value":"\"2024-04-12\""},{"type":"html","content":"<span class='clj-double'>896.9899902344</span>","value":"896.9899902344"},{"type":"html","content":"<span class='clj-double'>881.8599853516</span>","value":"881.8599853516"}],"value":"[\"2024-04-12\" 896.9899902344 881.8599853516]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-15&quot;</span>","value":"\"2024-04-15\""},{"type":"html","content":"<span class='clj-double'>890.9799804688</span>","value":"890.9799804688"},{"type":"html","content":"<span class='clj-double'>860.0100097656</span>","value":"860.0100097656"}],"value":"[\"2024-04-15\" 890.9799804688 860.0100097656]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-16&quot;</span>","value":"\"2024-04-16\""},{"type":"html","content":"<span class='clj-double'>864.3300170898</span>","value":"864.3300170898"},{"type":"html","content":"<span class='clj-double'>874.1500244141</span>","value":"874.1500244141"}],"value":"[\"2024-04-16\" 864.3300170898 874.1500244141]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-17&quot;</span>","value":"\"2024-04-17\""},{"type":"html","content":"<span class='clj-double'>883.4000244141</span>","value":"883.4000244141"},{"type":"html","content":"<span class='clj-double'>840.3499755859</span>","value":"840.3499755859"}],"value":"[\"2024-04-17\" 883.4000244141 840.3499755859]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-18&quot;</span>","value":"\"2024-04-18\""},{"type":"html","content":"<span class='clj-double'>849.700012207</span>","value":"849.700012207"},{"type":"html","content":"<span class='clj-double'>846.7100219727</span>","value":"846.7100219727"}],"value":"[\"2024-04-18\" 849.700012207 846.7100219727]"},{"type":"list-like","open":"<span class='clj-vector'>[</span>","close":"<span class='clj-vector'>]</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-string'>&quot;2024-04-19&quot;</span>","value":"\"2024-04-19\""},{"type":"html","content":"<span class='clj-double'>831.5</span>","value":"831.5"},{"type":"html","content":"<span class='clj-double'>762.0</span>","value":"762.0"}],"value":"[\"2024-04-19\" 831.5 762.0]"}],"value":"[[\"2024-02-16\" 741.0 726.0959472656] [\"2024-02-20\" 719.4699707031 694.4874267578] [\"2024-02-21\" 680.0599975586 674.688293457] [\"2024-02-22\" 750.25 785.3431396484] [\"2024-02-23\" 807.9000244141 788.1329956055] [\"2024-02-26\" 797.0 790.8828735352] [\"2024-02-27\" 793.8099975586 786.9730834961] [\"2024-02-28\" 776.200012207 776.5935668945] [\"2024-02-29\" 790.9400024414 791.0828857422] [\"2024-03-01\" 800.0 822.7514038086] [\"2024-03-04\" 841.299987793 852.3300170898] [\"2024-03-05\" 852.700012207 859.6400146484] [\"2024-03-06\" 880.2199707031 887.0] [\"2024-03-07\" 901.5800170898 926.6900024414] [\"2024-03-08\" 951.3800048828 875.2800292969] [\"2024-03-11\" 864.2899780273 857.7399902344] [\"2024-03-12\" 880.4899902344 919.1300048828] [\"2024-03-13\" 910.549987793 908.8800048828] [\"2024-03-14\" 895.7700195312 879.4400024414] [\"2024-03-15\" 869.299987793 878.3699951172] [\"2024-03-18\" 903.8800048828 884.549987793] [\"2024-03-19\" 867.0 893.9799804688] [\"2024-03-20\" 897.9699707031 903.7199707031] [\"2024-03-21\" 923.0 914.3499755859] [\"2024-03-22\" 911.4099731445 942.8900146484] [\"2024-03-25\" 939.4099731445 950.0200195312] [\"2024-03-26\" 958.5100097656 925.6099853516] [\"2024-03-27\" 931.1199951172 902.5] [\"2024-03-28\" 900.0 903.5599975586] [\"2024-04-01\" 902.9899902344 903.6300048828] [\"2024-04-02\" 884.4799804688 894.5200195312] [\"2024-04-03\" 884.8400268555 889.6400146484] [\"2024-04-04\" 904.0599975586 859.049987793] [\"2024-04-05\" 868.6599731445 880.0800170898] [\"2024-04-08\" 887.0 871.3300170898] [\"2024-04-09\" 874.4199829102 853.5399780273] [\"2024-04-10\" 839.2600097656 870.3900146484] [\"2024-04-11\" 874.200012207 906.1599731445] [\"2024-04-12\" 896.9899902344 881.8599853516] [\"2024-04-15\" 890.9799804688 860.0100097656] [\"2024-04-16\" 864.3300170898 874.1500244141] [\"2024-04-17\" 883.4000244141 840.3499755859] [\"2024-04-18\" 849.700012207 846.7100219727] [\"2024-04-19\" 831.5 762.0]]"}
;; <=

;; **
;;; ### Portfolio Processing Section
;; **

;; @@
(defn analyze-portfolio [data]
  (loop [cash 0.0
         portfolio {}
         portfolio-value {}
         current-value 0.0
         stock-performance {}
         cash-invested {}
         cash-invested-by-date {}
         data (rest data)]
    (if (empty? data)
      [cash portfolio portfolio-value current-value cash-invested cash-invested-by-date stock-performance]
      (let [[date action amount ticker] (first data)
            ticker-prices (client/get-ticker-price-all ticker (util/parse-date date))
            executed-date (first (first ticker-prices))				; gets the date the buy/sell order is executed
            ]
        (cond
          (= action "buy")
          (if (pos? (Double. amount))
            (let [price (second (first ticker-prices))        	; Gets open price of next trading day
                  currPrice (nth (last ticker-prices) 2)		; Gets adj close price of latest day
                  prices (mapv #(nth % 2) ticker-prices)       	; Extracts the prices from ticker-prices
                  amounts (repeatedly (count prices) #(Double. amount))	; Creates a sequence of amounts matching the number of prices
                  trading-dates (mapv #(first %) ticker-prices)
                  ]
              (recur (- cash (* (Double. amount) price))
                     (assoc portfolio ticker (+ (get portfolio ticker 0) (Double. amount)))
                     (merge-with + portfolio-value (zipmap (map first ticker-prices) (map #(- % (* (Double. amount) price))(map * prices amounts)))) ; Updates portfolio-value with the calculated values
                     (+ current-value (* (Double. amount) currPrice))
                     
                     (assoc stock-performance ticker (calculate-returns-with-corresponding-date prices trading-dates))
                     (assoc cash-invested ticker (+ (get cash-invested ticker 0) (* (Double. amount) price)))
                     (assoc cash-invested-by-date executed-date (assoc cash-invested ticker (+ (get cash-invested ticker 0) (* (Double. amount) price))))
                     (rest data)))
            (recur cash portfolio portfolio-value current-value cash-invested cash-invested-by-date stock-performance (rest data)))

          (= action "sell")
          (let [price (second (first ticker-prices))
                currPrice (second (last ticker-prices))
                prices (map second ticker-prices)
                amounts (repeatedly (count prices) #(Double. amount))
                trading-dates (mapv #(first %) ticker-prices)
                ]
            (recur (+ cash (* (Double. amount) price))
                   (assoc portfolio ticker (- (get portfolio ticker 0) (Double. amount)))
                   (merge-with + portfolio-value (zipmap (map first ticker-prices) (map #(- % (* (Double. amount) price))(map * prices amounts)))) ; Updates portfolio-value with the calculated values
                   (- current-value (* (Double. amount) currPrice))
                   
                   (assoc stock-performance ticker (calculate-returns-with-corresponding-date prices trading-dates))
                   (assoc cash-invested ticker (- (get cash-invested ticker 0) (* (Double. amount) price)))
                   (assoc cash-invested-by-date executed-date (assoc cash-invested ticker (- (get cash-invested ticker 0) (* (Double. amount) price))))
                   (rest data)))
          )))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;cim_portfolio.portfolio/analyze-portfolio</span>","value":"#'cim_portfolio.portfolio/analyze-portfolio"}
;; <=

;; @@
(def portfolio-options {
                        :starting-cash 200000
                       }
)

(def view-options {
                   :show-individual-stock-performance-by-day 	true
                   :show-cumulative-portfolio-return-by-day		true
                   :show-portfolio-value-by-day					true
                  }
)
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;cim_portfolio.portfolio/view-options</span>","value":"#'cim_portfolio.portfolio/view-options"}
;; <=

;; @@
(def input-file "examples/testPortfolio1.csv")

(let [data (util/read-csv input-file)
      [cash portfolio portfolio-value current-value cash-invested cash-invested-by-date stock-performance] (analyze-portfolio data)
      sorted-portfolio-value (map #(vector (first %) (+ (:starting-cash portfolio-options) (second %))) (util/sort-map-by-date portfolio-value))
      cash-invested-by-dates (into [] cash-invested-by-date)
      returns-by-date (zipmap (map #(first %) cash-invested-by-date)(mapv #(calculate-portfolio-return-for-given-date (second %) stock-performance (first %)) cash-invested-by-dates))
      ]
  (def portfolio-value-by-day sorted-portfolio-value)
  
  (println "\n\n----------------------------------")
  (println "Current Portfolio Value:" (format "%.2f" (+ (:starting-cash portfolio-options) (+ cash current-value))) "\n")
  (println "Cash On Hand (excluding value of portfolio):" (format "%.2f"(+ (:starting-cash portfolio-options) cash)) "\n")
  (println "Portfolio (units held of each stock):" portfolio "\n")
  (println "Cash invested in each stock: " cash-invested "\n")
  (println "Cumulative Portfolio Return: " (calculate-portfolio-return cash-invested stock-performance) "\n")
  
  (println "----------------------------------")
  (if (:show-cumulative-portfolio-return-by-day view-options) (println "Portfolio Return by date: \n" returns-by-date))
  (println "----------------------------------\n")
  
  (println "----------------------------------")
  (println "Portfolio Value Day-by-Day: ")
  (if (:show-portfolio-value-by-day view-options) 
    (run! println (map #(vector (first %) (format "%.2f" (second %))) sorted-portfolio-value))
    (println "Omitting...")
  )
  (println "----------------------------------\n")
  
  (println "----------------------------------")
  (println "Individual Stock Performance: ")
  (if (:show-individual-stock-performance-by-day view-options) 
    (clojure.pprint/pprint stock-performance)
    (println "Omitting...")
  )
  (println "----------------------------------\n")
)
;; @@
;; ->
;;; [*********************100%%**********************]  1 of 1 completed
;;; [*********************100%%**********************]  1 of 1 completed
;;; [*********************100%%**********************]  1 of 1 completed
;;; [*********************100%%**********************]  1 of 1 completed
;;; 
;;; 
;;; ----------------------------------
;;; Current Portfolio Value: 205243.70 
;;; 
;;; Cash On Hand (excluding value of portfolio): 150671.80 
;;; 
;;; Portfolio (units held of each stock): {NVDA 70.0, GOOG 50.0, TSLA -30.0} 
;;; 
;;; Cash invested in each stock:  {NVDA 48171.300659181, GOOG 7172.49984741, TSLA -6015.600128175} 
;;; 
;;; Cumulative Portfolio Return:  0.015247496553739127 
;;; 
;;; ----------------------------------
;;; Portfolio Return by date: 
;;;  {2024-02-16 -0.03867703657915007, 2024-02-26 -0.025080610779391756, 2024-03-01 -0.01478982974727278, 2024-03-11 -0.021283258141774782}
;;; ----------------------------------
;;; 
;;; ----------------------------------
;;; Portfolio Value Day-by-Day: 
;;; [2024-02-16 198509.59]
;;; [2024-02-20 195348.74]
;;; [2024-02-21 193368.83]
;;; [2024-02-22 204434.31]
;;; [2024-02-23 204713.30]
;;; [2024-02-26 204753.29]
;;; [2024-02-27 204429.81]
;;; [2024-02-28 203258.36]
;;; [2024-02-29 204824.79]
;;; [2024-03-01 207906.64]
;;; [2024-03-04 210616.80]
;;; [2024-03-05 210856.40]
;;; [2024-03-06 213439.60]
;;; [2024-03-07 217373.40]
;;; [2024-03-08 212499.40]
;;; [2024-03-11 210696.40]
;;; [2024-03-12 217425.00]
;;; [2024-03-13 217217.70]
;;; [2024-03-14 213850.40]
;;; [2024-03-15 212702.50]
;;; [2024-03-18 214879.20]
;;; [2024-03-19 214758.00]
;;; [2024-03-20 216768.30]
;;; [2024-03-21 218636.90]
;;; [2024-03-22 221003.70]
;;; [2024-03-25 222587.80]
;;; [2024-03-26 221041.90]
;;; [2024-03-27 218006.10]
;;; [2024-03-28 217075.70]
;;; [2024-04-01 217346.00]
;;; [2024-04-02 215505.60]
;;; [2024-04-03 215031.50]
;;; [2024-04-04 212509.10]
;;; [2024-04-05 213620.40]
;;; [2024-04-08 213413.40]
;;; [2024-04-09 211464.10]
;;; [2024-04-10 212074.20]
;;; [2024-04-11 216841.20]
;;; [2024-04-12 215008.60]
;;; [2024-04-15 212437.30]
;;; [2024-04-16 212630.30]
;;; [2024-04-17 209893.40]
;;; [2024-04-18 209355.70]
;;; [2024-04-19 200183.30]
;;; ----------------------------------
;;; 
;;; ----------------------------------
;;; Individual Stock Performance: 
;;; {&quot;NVDA&quot;
;;;  {:cumulative-return -0.03867703657915007,
;;;   :arithmetic-returns
;;;   {&quot;2024-03-12&quot; 0.018743723309248228,
;;;    &quot;2024-03-13&quot; 0.03414007869708735,
;;;    &quot;2024-03-14&quot; -0.016231913085435146,
;;;    &quot;2024-03-15&quot; -0.029550030879636924,
;;;    &quot;2024-03-18&quot; 0.039779152853312016,
;;;    &quot;2024-03-19&quot; -0.04080188153689934,
;;;    &quot;2024-03-20&quot; 0.03572084279480969,
;;;    &quot;2024-03-21&quot; 0.027874015962139342,
;;;    &quot;2024-03-22&quot; -0.012556908835861358,
;;;    &quot;2024-03-25&quot; 0.03072163002934425,
;;;    &quot;2024-03-26&quot; 0.020331950018761535,
;;;    &quot;2024-03-27&quot; -0.028575616706494444,
;;;    &quot;2024-03-28&quot; -0.03342211023326047,
;;;    &quot;2024-04-01&quot; 0.003322211371555639,
;;;    &quot;2024-04-02&quot; -0.02049857691201551,
;;;    &quot;2024-04-03&quot; 4.070712674686394E-4,
;;;    &quot;2024-04-04&quot; 0.02172140739541706,
;;;    &quot;2024-04-05&quot; -0.039156720250533406,
;;;    &quot;2024-04-08&quot; 0.021113010179472314,
;;;    &quot;2024-04-09&quot; -0.014182657372942442,
;;;    &quot;2024-04-10&quot; -0.04020948037758976,
;;;    &quot;2024-04-11&quot; 0.04163191625341289,
;;;    &quot;2024-04-12&quot; 0.026069523803671224,
;;;    &quot;2024-04-15&quot; -0.006700197138241659,
;;;    &quot;2024-04-16&quot; -0.029910844197619135,
;;;    &quot;2024-04-17&quot; 0.02206334032978363,
;;;    &quot;2024-04-18&quot; -0.03814807706106982,
;;;    &quot;2024-04-19&quot; -0.02141933852599054},
;;;   :log-returns
;;;   {&quot;2024-03-12&quot; 0.01857022438511924,
;;;    &quot;2024-03-13&quot; 0.03357023953839369,
;;;    &quot;2024-03-14&quot; -0.01636509373764299,
;;;    &quot;2024-03-15&quot; -0.029995429355316856,
;;;    &quot;2024-03-18&quot; 0.039008337577523575,
;;;    &quot;2024-03-19&quot; -0.04165763683966735,
;;;    &quot;2024-03-20&quot; 0.035097650765528586,
;;;    &quot;2024-03-21&quot; 0.027492606956781733,
;;;    &quot;2024-03-22&quot; -0.012636413068358577,
;;;    &quot;2024-03-25&quot; 0.03025916860673016,
;;;    &quot;2024-03-26&quot; 0.020128015546544874,
;;;    &quot;2024-03-27&quot; -0.028991848198055024,
;;;    &quot;2024-03-28&quot; -0.03399339406540293,
;;;    &quot;2024-04-01&quot; 0.0033167050194969068,
;;;    &quot;2024-04-02&quot; -0.020711588726739456,
;;;    &quot;2024-04-03&quot; 4.0698843643823283E-4,
;;;    &quot;2024-04-04&quot; 0.021488859117099194,
;;;    &quot;2024-04-05&quot; -0.039943963696467195,
;;;    &quot;2024-04-08&quot; 0.020893218835441294,
;;;    &quot;2024-04-09&quot; -0.01428419242590349,
;;;    &quot;2024-04-10&quot; -0.041040227057899226,
;;;    &quot;2024-04-11&quot; 0.0407886335670611,
;;;    &quot;2024-04-12&quot; 0.025735506444720013,
;;;    &quot;2024-04-15&quot; -0.006722744228823572,
;;;    &quot;2024-04-16&quot; -0.03036729851013696,
;;;    &quot;2024-04-17&quot; 0.021823466700346357,
;;;    &quot;2024-04-18&quot; -0.038894766423201305,
;;;    &quot;2024-04-19&quot; -0.02165206174276012}},
;;;  &quot;GOOG&quot;
;;;  {:cumulative-return 0.11538577795478142,
;;;   :arithmetic-returns
;;;   {&quot;2024-02-27&quot; 0.00972977371891881,
;;;    &quot;2024-02-28&quot; -0.019057910859243576,
;;;    &quot;2024-02-29&quot; 0.01709965967213356,
;;;    &quot;2024-03-01&quot; -0.012161947081457236,
;;;    &quot;2024-03-04&quot; -0.028099687365633286,
;;;    &quot;2024-03-05&quot; -0.003129643654627867,
;;;    &quot;2024-03-06&quot; -0.009119459050920375,
;;;    &quot;2024-03-07&quot; 0.02021732033764745,
;;;    &quot;2024-03-08&quot; 0.007763884577428604,
;;;    &quot;2024-03-11&quot; 0.01944390113613914,
;;;    &quot;2024-03-12&quot; 0.0048941461339531145,
;;;    &quot;2024-03-13&quot; 0.008236708175892948,
;;;    &quot;2024-03-14&quot; 0.025360460020227737,
;;;    &quot;2024-03-15&quot; -0.015033935319771152,
;;;    &quot;2024-03-18&quot; 0.04438346795998149,
;;;    &quot;2024-03-19&quot; -0.0037715353900450443,
;;;    &quot;2024-03-20&quot; 0.01189828642973878,
;;;    &quot;2024-03-21&quot; -0.006279978812104736,
;;;    &quot;2024-03-22&quot; 0.020371108426767703,
;;;    &quot;2024-03-25&quot; -0.00408519706494026,
;;;    &quot;2024-03-26&quot; 0.003638789771150286,
;;;    &quot;2024-03-27&quot; 0.0015821061175231854,
;;;    &quot;2024-03-28&quot; 0.002106042255221263,
;;;    &quot;2024-04-01&quot; 0.027847140720937302,
;;;    &quot;2024-04-02&quot; -0.004025590305431259,
;;;    &quot;2024-04-03&quot; 0.003207801473426919,
;;;    &quot;2024-04-04&quot; -0.02833019641958623,
;;;    &quot;2024-04-05&quot; 0.013163090482188,
;;;    &quot;2024-04-08&quot; 0.014291262266528104,
;;;    &quot;2024-04-09&quot; 0.012809017598428563,
;;;    &quot;2024-04-10&quot; -0.0030352581848535065,
;;;    &quot;2024-04-11&quot; 0.019852781626900518,
;;;    &quot;2024-04-12&quot; -0.009950811067285126,
;;;    &quot;2024-04-15&quot; -0.017965956193466415,
;;;    &quot;2024-04-16&quot; -0.002110930897682217,
;;;    &quot;2024-04-17&quot; 0.0056410569410256794,
;;;    &quot;2024-04-18&quot; 0.003697104876642987,
;;;    &quot;2024-04-19&quot; -0.011050459920032396},
;;;   :log-returns
;;;   {&quot;2024-02-27&quot; 0.009682744281726864,
;;;    &quot;2024-02-28&quot; -0.01924185363555232,
;;;    &quot;2024-02-29&quot; 0.016955106043255397,
;;;    &quot;2024-03-01&quot; -0.012236508719703257,
;;;    &quot;2024-03-04&quot; -0.028502038799374928,
;;;    &quot;2024-03-05&quot; -0.003134551231316087,
;;;    &quot;2024-03-06&quot; -0.009161295864592816,
;;;    &quot;2024-03-07&quot; 0.020015663756857732,
;;;    &quot;2024-03-08&quot; 0.007733900719707719,
;;;    &quot;2024-03-11&quot; 0.01925728365879598,
;;;    &quot;2024-03-12&quot; 0.004882208733839472,
;;;    &quot;2024-03-13&quot; 0.008202971620612674,
;;;    &quot;2024-03-14&quot; 0.025044219081981015,
;;;    &quot;2024-03-15&quot; -0.015148090504825953,
;;;    &quot;2024-03-18&quot; 0.043426728495015436,
;;;    &quot;2024-03-19&quot; -0.0037786655630901826,
;;;    &quot;2024-03-20&quot; 0.011828058333563249,
;;;    &quot;2024-03-21&quot; -0.006299780826732111,
;;;    &quot;2024-03-22&quot; 0.020166392916391915,
;;;    &quot;2024-03-25&quot; -0.004093564278054266,
;;;    &quot;2024-03-26&quot; 0.003632185392100155,
;;;    &quot;2024-03-27&quot; 0.001580855906110676,
;;;    &quot;2024-03-28&quot; 0.00210382765704401,
;;;    &quot;2024-04-01&quot; 0.02746646017990375,
;;;    &quot;2024-04-02&quot; -0.004033714805353822,
;;;    &quot;2024-04-03&quot; 0.0032026674546259083,
;;;    &quot;2024-04-04&quot; -0.028739240486219824,
;;;    &quot;2024-04-05&quot; 0.01307720982233686,
;;;    &quot;2024-04-08&quot; 0.014190104817235887,
;;;    &quot;2024-04-09&quot; 0.012727676000077327,
;;;    &quot;2024-04-10&quot; -0.003039873923316099,
;;;    &quot;2024-04-11&quot; 0.01965828514101921,
;;;    &quot;2024-04-12&quot; -0.010000651297178366,
;;;    &quot;2024-04-15&quot; -0.01812930340115913,
;;;    &quot;2024-04-16&quot; -0.0021131620527386707,
;;;    &quot;2024-04-17&quot; 0.00562520576297966,
;;;    &quot;2024-04-18&quot; 0.0036902873825688087,
;;;    &quot;2024-04-19&quot; -0.011111969813760454}},
;;;  &quot;TSLA&quot;
;;;  {:cumulative-return -0.2971690621166354,
;;;   :arithmetic-returns
;;;   {&quot;2024-03-04&quot; -0.008926832769100779,
;;;    &quot;2024-03-05&quot; -0.0789009863272001,
;;;    &quot;2024-03-06&quot; -0.016716730442960293,
;;;    &quot;2024-03-07&quot; -0.03133506982371348,
;;;    &quot;2024-03-08&quot; 0.041009427279603994,
;;;    &quot;2024-03-11&quot; -0.03333335014765837,
;;;    &quot;2024-03-12&quot; 0.01322318247166998,
;;;    &quot;2024-03-13&quot; -0.026551167841931345,
;;;    &quot;2024-03-14&quot; -0.0305114052943386,
;;;    &quot;2024-03-15&quot; -0.02747809794957279,
;;;    &quot;2024-03-18&quot; 0.04204462157654065,
;;;    &quot;2024-03-19&quot; 0.013763064810594638,
;;;    &quot;2024-03-20&quot; 0.003713154950878872,
;;;    &quot;2024-03-21&quot; 0.019595372194219696,
;;;    &quot;2024-03-22&quot; -0.054991762468206695,
;;;    &quot;2024-03-25&quot; 0.012418213660580601,
;;;    &quot;2024-03-26&quot; 0.058189189641768335,
;;;    &quot;2024-03-27&quot; 0.01584724942312743,
;;;    &quot;2024-03-28&quot; -0.021829042687612876,
;;;    &quot;2024-04-01&quot; -0.0072132927659257495,
;;;    &quot;2024-04-02&quot; -0.06482374006697367,
;;;    &quot;2024-04-03&quot; -0.004430930060698057,
;;;    &quot;2024-04-04&quot; 0.036885763285609,
;;;    &quot;2024-04-05&quot; -0.005821164523223565,
;;;    &quot;2024-04-08&quot; 0.001537701111806955,
;;;    &quot;2024-04-09&quot; 0.021081890878729137,
;;;    &quot;2024-04-10&quot; 7.517761913535814E-4,
;;;    &quot;2024-04-11&quot; -0.0028316588841394985,
;;;    &quot;2024-04-12&quot; -0.0012170774279091079,
;;;    &quot;2024-04-15&quot; -0.012185162407585604,
;;;    &quot;2024-04-16&quot; -0.07929980947127757,
;;;    &quot;2024-04-17&quot; 0.005741953967451252,
;;;    &quot;2024-04-18&quot; -0.040535393392177155,
;;;    &quot;2024-04-19&quot; -0.01507437209454543},
;;;   :log-returns
;;;   {&quot;2024-03-04&quot; -0.008966915661229745,
;;;    &quot;2024-03-05&quot; -0.08218774180298156,
;;;    &quot;2024-03-06&quot; -0.016858031927332002,
;;;    &quot;2024-03-07&quot; -0.03183651618203155,
;;;    &quot;2024-03-08&quot; 0.040190845576076405,
;;;    &quot;2024-03-11&quot; -0.033901569069810844,
;;;    &quot;2024-03-12&quot; 0.013136519333363105,
;;;    &quot;2024-03-13&quot; -0.026910016251739145,
;;;    &quot;2024-03-14&quot; -0.030986568467997484,
;;;    &quot;2024-03-15&quot; -0.02786268235452426,
;;;    &quot;2024-03-18&quot; 0.041184765424412045,
;;;    &quot;2024-03-19&quot; 0.013669213970453118,
;;;    &quot;2024-03-20&quot; 0.003706278208716729,
;;;    &quot;2024-03-21&quot; 0.01940585466509325,
;;;    &quot;2024-03-22&quot; -0.05656163456152617,
;;;    &quot;2024-03-25&quot; 0.012341740104424025,
;;;    &quot;2024-03-26&quot; 0.05655913563696795,
;;;    &quot;2024-03-27&quot; 0.015722992797362372,
;;;    &quot;2024-03-28&quot; -0.022070821245679117,
;;;    &quot;2024-04-01&quot; -0.007239434349310188,
;;;    &quot;2024-04-02&quot; -0.06702025416249456,
;;;    &quot;2024-04-03&quot; -0.004440775725699217,
;;;    &quot;2024-04-04&quot; 0.03622176241320018,
;;;    &quot;2024-04-05&quot; -0.005838173541743741,
;;;    &quot;2024-04-08&quot; 0.0015365200600337267,
;;;    &quot;2024-04-09&quot; 0.02086274250751641,
;;;    &quot;2024-04-10&quot; 7.514937491793084E-4,
;;;    &quot;2024-04-11&quot; -0.0028356756146232704,
;;;    &quot;2024-04-12&quot; -0.0012178186681340737,
;;;    &quot;2024-04-15&quot; -0.012260010141679696,
;;;    &quot;2024-04-16&quot; -0.08262082174937443,
;;;    &quot;2024-04-17&quot; 0.005725531783397452,
;;;    &quot;2024-04-18&quot; -0.041379851543738425,
;;;    &quot;2024-04-19&quot; -0.01518914532518197}}}
;;; ----------------------------------
;;; 
;;; 
;; <-
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; @@
(plot/list-plot (cons (:starting-cash portfolio-options) (map #(second %) portfolio-value-by-day)) :joined true :plot-size 600)
;; @@
;; =>
;;; {"type":"vega","content":{"width":600,"height":370.8282,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"33478978-9bb5-4531-befc-cc8d1d218585","values":[{"x":0,"y":200000},{"x":1,"y":198509.59472656},{"x":2,"y":195348.74267578},{"x":3,"y":193368.82934569998},{"x":4,"y":204434.31396484},{"x":5,"y":204713.29956055002},{"x":6,"y":204753.28750611},{"x":7,"y":204429.808807375},{"x":8,"y":203258.35647583},{"x":9,"y":204824.788665775},{"x":10,"y":207906.640625005},{"x":11,"y":210616.80145263},{"x":12,"y":210856.401519774},{"x":13,"y":213439.600067141},{"x":14,"y":217373.40072632},{"x":15,"y":212499.40261841},{"x":16,"y":210696.399078371},{"x":17,"y":217425.000762943},{"x":18,"y":217217.701110845},{"x":19,"y":213850.401458742},{"x":20,"y":212702.499847414},{"x":21,"y":214879.19952393},{"x":22,"y":214757.998657233},{"x":23,"y":216768.296508789},{"x":24,"y":218636.898498534},{"x":25,"y":221003.701629638},{"x":26,"y":222587.80136108},{"x":27,"y":221041.899414067},{"x":28,"y":218006.100769045},{"x":29,"y":217075.700073242},{"x":30,"y":217346.00082397502},{"x":31,"y":215505.60180663998},{"x":32,"y":215031.502838136},{"x":33,"y":212509.09973145},{"x":34,"y":213620.401763914},{"x":35,"y":213413.402252193},{"x":36,"y":211464.098052975},{"x":37,"y":212074.202423092},{"x":38,"y":216841.198120115},{"x":39,"y":215008.598937995},{"x":40,"y":212437.301330571},{"x":41,"y":212630.303802496},{"x":42,"y":209893.399200437},{"x":43,"y":209355.703582771},{"x":44,"y":200183.300781252}]}],"marks":[{"type":"line","from":{"data":"33478978-9bb5-4531-befc-cc8d1d218585"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"33478978-9bb5-4531-befc-cc8d1d218585","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"33478978-9bb5-4531-befc-cc8d1d218585","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 600, :height 370.8282, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"33478978-9bb5-4531-befc-cc8d1d218585\", :values ({:x 0, :y 200000} {:x 1, :y 198509.59472656} {:x 2, :y 195348.74267578} {:x 3, :y 193368.82934569998} {:x 4, :y 204434.31396484} {:x 5, :y 204713.29956055002} {:x 6, :y 204753.28750611} {:x 7, :y 204429.808807375} {:x 8, :y 203258.35647583} {:x 9, :y 204824.788665775} {:x 10, :y 207906.640625005} {:x 11, :y 210616.80145263} {:x 12, :y 210856.401519774} {:x 13, :y 213439.600067141} {:x 14, :y 217373.40072632} {:x 15, :y 212499.40261841} {:x 16, :y 210696.399078371} {:x 17, :y 217425.000762943} {:x 18, :y 217217.701110845} {:x 19, :y 213850.401458742} {:x 20, :y 212702.499847414} {:x 21, :y 214879.19952393} {:x 22, :y 214757.998657233} {:x 23, :y 216768.296508789} {:x 24, :y 218636.898498534} {:x 25, :y 221003.701629638} {:x 26, :y 222587.80136108} {:x 27, :y 221041.899414067} {:x 28, :y 218006.100769045} {:x 29, :y 217075.700073242} {:x 30, :y 217346.00082397502} {:x 31, :y 215505.60180663998} {:x 32, :y 215031.502838136} {:x 33, :y 212509.09973145} {:x 34, :y 213620.401763914} {:x 35, :y 213413.402252193} {:x 36, :y 211464.098052975} {:x 37, :y 212074.202423092} {:x 38, :y 216841.198120115} {:x 39, :y 215008.598937995} {:x 40, :y 212437.301330571} {:x 41, :y 212630.303802496} {:x 42, :y 209893.399200437} {:x 43, :y 209355.703582771} {:x 44, :y 200183.300781252})}], :marks [{:type \"line\", :from {:data \"33478978-9bb5-4531-befc-cc8d1d218585\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"33478978-9bb5-4531-befc-cc8d1d218585\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"33478978-9bb5-4531-befc-cc8d1d218585\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=
